/******************************************************************************
* Copyright (c) 2004-2011 O. Dolomanov, OlexSys                               *
*                                                                             *
* This file is part of the OlexSys Development Framework.                     *
*                                                                             *
* This source file is distributed under the terms of the licence located in   *
* the root folder.                                                            *
******************************************************************************/

#include "symmcon.h"

SymmConItem SymmCon_00111[] = {{0,1}, {1,1}, {2,1}, {3,1}, {4,1}, {5,1}, {0,1}, {1,1}, {2,1}};
SymmConItem SymmCon_02311[] = {{0,1}, {1,1}, {2,1}, {-2,0}, {-2,0}, {5,1}, {-2,0}, {-2,0}, {2,1}};
SymmConItem SymmCon_22311[] = {{0,1}, {1,1}, {2,1}, {3,1}, {4,1}, {5,1}, {-2,0}, {-2,0}, {-2,0}};
SymmConItem SymmCon_20111[] = {{0,1}, {1,1}, {2,1}, {-2,0}, {-2,0}, {5,1}, {0,1}, {1,1}, {-2,0}};
SymmConItem SymmCon_20311[] = {{0,1}, {1,1}, {2,1}, {-2,0}, {4,1}, {-2,0}, {-2,0}, {1,1}, {-2,0}};
SymmConItem SymmCon_02111[] = {{0,1}, {1,1}, {2,1}, {-2,0}, {4,1}, {-2,0}, {0,1}, {-2,0}, {2,1}};
SymmConItem SymmCon_22111[] = {{0,1}, {1,1}, {2,1}, {3,1}, {-2,0}, {-2,0}, {0,1}, {-2,0}, {-2,0}};
SymmConItem SymmCon_00311[] = {{0,1}, {1,1}, {2,1}, {3,1}, {-2,0}, {-2,0}, {-2,0}, {1,1}, {2,1}};
SymmConItem SymmCon_2110a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {-2,0}, {0,1}, {0,-1}, {-2,0}};
SymmConItem SymmCon_2050a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {-2,0}, {0,1}, {0,1}, {-2,0}};
SymmConItem SymmCon_102a1[] = {{0,1}, {1,1}, {1,1}, {-2,0}, {4,1}, {4,-1}, {-2,0}, {1,1}, {1,-1}};
SymmConItem SymmCon_042a1[] = {{0,1}, {1,1}, {1,1}, {-2,0}, {4,1}, {4,1}, {-2,0}, {1,1}, {1,1}};
SymmConItem SymmCon_02854[] = {{0,1}, {1,1}, {0,1}, {3,1}, {-2,0}, {3,1}, {0,1}, {-2,0}, {0,1}};
SymmConItem SymmCon_0a054[] = {{0,1}, {1,1}, {0,1}, {3,1}, {-2,0}, {3,-1}, {0,1}, {-2,0}, {0,-1}};
SymmConItem SymmCon_0008c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,1}, {0,1}, {0,1}, {0,1}};
SymmConItem SymmCon_00062[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,1}, {0,1}, {0,1}, {0,1}};
SymmConItem SymmCon_04462[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,1}, {0,1}, {0,-1}, {0,1}};
SymmConItem SymmCon_1108c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,1}, {0,1}, {0,-1}, {0,1}};
SymmConItem SymmCon_08462[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,-1}, {0,1}, {0,-1}, {0,-1}};
SymmConItem SymmCon_0188c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,-1}, {0,1}, {0,-1}, {0,-1}};
SymmConItem SymmCon_1088c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,-1}, {0,1}, {0,1}, {0,-1}};
SymmConItem SymmCon_0c062[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,-1}, {0,1}, {0,1}, {0,-1}};
SymmConItem SymmCon_0150a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {5,1}, {0,1}, {0,-1}, {2,1}};
SymmConItem SymmCon_0010a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {5,1}, {0,1}, {0,1}, {2,1}};
SymmConItem SymmCon_140a1[] = {{0,1}, {1,1}, {1,1}, {3,1}, {4,1}, {4,-1}, {0,1}, {1,1}, {1,-1}};
SymmConItem SymmCon_000a1[] = {{0,1}, {1,1}, {1,1}, {3,1}, {4,1}, {4,1}, {0,1}, {1,1}, {1,1}};
SymmConItem SymmCon_08854[] = {{0,1}, {1,1}, {0,1}, {3,1}, {4,1}, {3,-1}, {0,1}, {1,1}, {0,-1}};
SymmConItem SymmCon_00054[] = {{0,1}, {1,1}, {0,1}, {3,1}, {4,1}, {3,1}, {0,1}, {1,1}, {0,1}};
SymmConItem SymmCon_0050a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {-2,0}, {0,1}, {0,1}, {2,1}};
SymmConItem SymmCon_0110a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {-2,0}, {0,1}, {0,-1}, {2,1}};
SymmConItem SymmCon_040a1[] = {{0,1}, {1,1}, {1,1}, {-2,0}, {4,1}, {4,-1}, {0,1}, {1,1}, {1,1}};
SymmConItem SymmCon_100a1[] = {{0,1}, {1,1}, {1,1}, {-2,0}, {4,1}, {4,1}, {0,1}, {1,1}, {1,-1}};
SymmConItem SymmCon_08054[] = {{0,1}, {1,1}, {0,1}, {3,1}, {-2,0}, {3,1}, {0,1}, {1,1}, {0,-1}};
SymmConItem SymmCon_00854[] = {{0,1}, {1,1}, {0,1}, {3,1}, {-2,0}, {3,-1}, {0,1}, {1,1}, {0,1}};
SymmConItem SymmCon_2010a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {5,1}, {0,1}, {0,1}, {-2,0}};
SymmConItem SymmCon_2150a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {5,1}, {0,1}, {0,-1}, {-2,0}};
SymmConItem SymmCon_002a1[] = {{0,1}, {1,1}, {1,1}, {3,1}, {4,1}, {4,-1}, {-2,0}, {1,1}, {1,1}};
SymmConItem SymmCon_142a1[] = {{0,1}, {1,1}, {1,1}, {3,1}, {4,1}, {4,1}, {-2,0}, {1,1}, {1,-1}};
SymmConItem SymmCon_02054[] = {{0,1}, {1,1}, {0,1}, {3,1}, {4,1}, {3,-1}, {0,1}, {-2,0}, {0,1}};
SymmConItem SymmCon_0a854[] = {{0,1}, {1,1}, {0,1}, {3,1}, {4,1}, {3,1}, {0,1}, {-2,0}, {0,-1}};
SymmConItem SymmCon_1188c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,1}, {0,1}, {0,-1}, {0,-1}};
SymmConItem SymmCon_0c462[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,1}, {0,1}, {0,-1}, {0,-1}};
SymmConItem SymmCon_08062[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,1}, {0,1}, {0,1}, {0,-1}};
SymmConItem SymmCon_0088c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,1}, {0,1}, {0,1}, {0,-1}};
SymmConItem SymmCon_04062[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,-1}, {0,1}, {0,1}, {0,1}};
SymmConItem SymmCon_1008c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,-1}, {3,-1}, {0,1}, {0,1}, {0,1}};
SymmConItem SymmCon_0108c[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,-1}, {0,1}, {0,-1}, {0,1}};
SymmConItem SymmCon_00462[] = {{0,1}, {0,1}, {0,1}, {3,1}, {3,1}, {3,-1}, {0,1}, {0,-1}, {0,1}};
SymmConItem SymmCon_0251a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {0,0.5}, {0,1}, {0,1}, {2,1}};
SymmConItem SymmCon_2111a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,-1}, {0,0.5}, {0,1}, {0,-1}, {-2,0}};
SymmConItem SymmCon_0130b[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,0.5}, {0,0.5}, {0,1}, {0,-2}, {2,1}};
SymmConItem SymmCon_2050b[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,0.5}, {0,0.5}, {-2,0}, {0,-1}, {-2,0}};
SymmConItem SymmCon_20313[] = {{-1,0}, {1,1}, {2,1}, {-2,0}, {3,-0}, {1,0.5}, {-2,0}, {0,1}, {-2,0}};
SymmConItem SymmCon_02513[] = {{-1,0}, {1,1}, {2,1}, {-2,0}, {3,-0}, {1,0.5}, {0,1}, {0,-0.5}, {2,1}};
SymmConItem SymmCon_22119[] = {{0,1}, {-1,0}, {2,1}, {4,-0}, {-2,0}, {0,0.5}, {0,1}, {-2,0}, {-2,0}};
SymmConItem SymmCon_01319[] = {{0,1}, {-1,0}, {2,1}, {4,-0}, {-2,0}, {0,0.5}, {1,-0.5}, {1,1}, {2,1}};
SymmConItem SymmCon_22513[] = {{-1,0}, {1,1}, {2,1}, {3,1}, {3,0.5}, {1,0.5}, {0,1}, {0,-0.5}, {-2,0}};
SymmConItem SymmCon_00313[] = {{-1,0}, {1,1}, {2,1}, {3,1}, {3,0.5}, {1,0.5}, {-2,0}, {0,1}, {2,1}};
SymmConItem SymmCon_21319[] = {{0,1}, {-1,0}, {2,1}, {3,1}, {3,2}, {0,0.5}, {1,-0.5}, {1,1}, {-2,0}};
SymmConItem SymmCon_02119[] = {{0,1}, {-1,0}, {2,1}, {3,1}, {3,2}, {0,0.5}, {0,1}, {-2,0}, {2,1}};
SymmConItem SymmCon_2130b[] = {{0,1}, {0,1}, {2,1}, {-2,0}, {3,-0}, {0,0.5}, {0,1}, {0,-2}, {-2,0}};
SymmConItem SymmCon_2251a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {0,0.5}, {0,1}, {0,1}, {-2,0}};
SymmConItem SymmCon_0050b[] = {{0,1}, {0,1}, {2,1}, {-2,0}, {3,-0}, {0,0.5}, {-2,0}, {0,-1}, {2,1}};
SymmConItem SymmCon_0111a[] = {{0,1}, {0,1}, {2,1}, {3,1}, {3,1}, {0,0.5}, {0,1}, {0,-1}, {2,1}};

SymmCon SortedSymmConTab[64] = {
  {0x00054, SymmCon_00054},
  {0x00062, SymmCon_00062},
  {0x0008c, SymmCon_0008c},
  {0x000a1, SymmCon_000a1},
  {0x0010a, SymmCon_0010a},
  {0x00111, SymmCon_00111},
  {0x002a1, SymmCon_002a1},
  {0x00311, SymmCon_00311},
  {0x00313, SymmCon_00313},
  {0x00462, SymmCon_00462},
  {0x0050a, SymmCon_0050a},
  {0x0050b, SymmCon_0050b},
  {0x00854, SymmCon_00854},
  {0x0088c, SymmCon_0088c},
  {0x0108c, SymmCon_0108c},
  {0x0110a, SymmCon_0110a},
  {0x0111a, SymmCon_0111a},
  {0x0130b, SymmCon_0130b},
  {0x01319, SymmCon_01319},
  {0x0150a, SymmCon_0150a},
  {0x0188c, SymmCon_0188c},
  {0x02054, SymmCon_02054},
  {0x02111, SymmCon_02111},
  {0x02119, SymmCon_02119},
  {0x02311, SymmCon_02311},
  {0x02513, SymmCon_02513},
  {0x0251a, SymmCon_0251a},
  {0x02854, SymmCon_02854},
  {0x04062, SymmCon_04062},
  {0x040a1, SymmCon_040a1},
  {0x042a1, SymmCon_042a1},
  {0x04462, SymmCon_04462},
  {0x08054, SymmCon_08054},
  {0x08062, SymmCon_08062},
  {0x08462, SymmCon_08462},
  {0x08854, SymmCon_08854},
  {0x0a054, SymmCon_0a054},
  {0x0a854, SymmCon_0a854},
  {0x0c062, SymmCon_0c062},
  {0x0c462, SymmCon_0c462},
  {0x1008c, SymmCon_1008c},
  {0x100a1, SymmCon_100a1},
  {0x102a1, SymmCon_102a1},
  {0x1088c, SymmCon_1088c},
  {0x1108c, SymmCon_1108c},
  {0x1188c, SymmCon_1188c},
  {0x140a1, SymmCon_140a1},
  {0x142a1, SymmCon_142a1},
  {0x2010a, SymmCon_2010a},
  {0x20111, SymmCon_20111},
  {0x20311, SymmCon_20311},
  {0x20313, SymmCon_20313},
  {0x2050a, SymmCon_2050a},
  {0x2050b, SymmCon_2050b},
  {0x2110a, SymmCon_2110a},
  {0x2111a, SymmCon_2111a},
  {0x2130b, SymmCon_2130b},
  {0x21319, SymmCon_21319},
  {0x2150a, SymmCon_2150a},
  {0x22111, SymmCon_22111},
  {0x22119, SymmCon_22119},
  {0x22311, SymmCon_22311},
  {0x22513, SymmCon_22513},
  {0x2251a, SymmCon_2251a},
};
//..............................................................................
SiteSymmCon::SiteSymmCon() : added(false)  {
  for( int i=0; i < 9; i++ )  {
    map[i].param = (i < 6 ? i : i-6);
    map[i].multiplier = 1.0;
  }
};
//..............................................................................
SiteSymmCon& SiteSymmCon::operator += (const SymmCon* sc)  {
  if( sc == NULL )
    throw TFunctionFailedException(__OlxSourceInfo, olxstr("implementation error") << 1);
  if( added )  {  // has been initialised?
    for( int i=0; i < 9; i++ )  {
      if( map[i].param == -2 )  // cancelled
        continue;
      if( map[i].param == -1 )  // uknown?
        map[i].param = sc->map[i].param;
      else  {
        if( map[i].param != sc->map[i].param )  {
          if( sc->map[i].param == -2 )  //cancelled out? apply
            map[i].param = -2;
          else if( map[i].param == -1 ) // unknown? skip
            ;
          else {
            if( map[i].param > sc->map[i].param )
              map[i].param = sc->map[i].param;
          }
        }
        else if( olx_sign(map[i].multiplier) != olx_sign(sc->map[i].multiplier) )  {
          if( map[i].param > 0 )
            map[map[i].param].param = -2;
          map[i].param = -2;
        }
      }
    }
  }
  else  {
    for( size_t i=0; i < 9; i++ )  {
      map[i].param = sc->map[i].param;
      map[i].multiplier = sc->map[i].multiplier;
    }
    added = true;
  }
  return *this;
}
//..............................................................................
bool SiteSymmCon::IsConstrained() const {
  for( int i=0; i < 9; i++ )
    if( map[i].param != (i < 6 ? i : i-6) )
      return true;
  return false;
}
//..............................................................................
olxstr SiteSymmCon::ToString() const {
  static olxstr u_legend[] = {"U11", "U22", "U33", "U23", "U13", "U12"};
  static olxstr c_legend[] = {"X", "Y", "Z"};
  olxstr rv;
  for( int i=0; i < 6; i++ )  {
    if( map[i].param == i )  // skip Uxx=Uxx etc
      continue;
    if( !rv.IsEmpty() )  rv << ',';
    rv << u_legend[i] << '=';
    if( map[i].param >= 0 )  {
      if( olx_abs(map[i].multiplier) == 1 )  {
        if( map[i].multiplier < 0 )
          rv << '-';
      }
      else
        rv << map[i].multiplier << '*';
      rv << u_legend[map[i].param];
    }
    else if( map[i].param == -1 )
      rv << '?';
    else if( map[i].param == -2 )
      rv << '0';
  }
  for( int i=0; i < 3; i++ )  {
    const int pi = i+6;
    if( map[pi].param == i )  // skip X=X etc
      continue;
    if( !rv.IsEmpty() )  rv << ',';
    rv << c_legend[i] << '=';
    if( map[pi].param >= 0 )  {
      if( olx_abs(map[pi].multiplier) == 1 )  {
        if( map[pi].multiplier < 0 )
          rv << '-';
      }
      else
        rv << map[pi].multiplier << '*';
      rv << c_legend[map[pi].param];
    }
    else if( map[pi].param == -1 )
      rv << '?';
    else if( map[pi].param == -2 )
      rv << '0';
  }
  return rv;
}
//..............................................................................
const SymmCon* SymmConReg::_Find(int r_id)  {
  size_t from = 0, to = 63;
  const int from_cr = SortedSymmConTab[from].r_id - r_id;
  if( from_cr == 0 )  return &SortedSymmConTab[from];
  if( from_cr > 0  )  return NULL;
  const int to_cr = SortedSymmConTab[to].r_id - r_id;
  if( to_cr == 0 )  return &SortedSymmConTab[to];
  if( to_cr < 0  )  return NULL;
  while( true ) {
    const size_t index = (to+from)/2;
    if( index == from || index == to)
      return NULL;
    const int cr = SortedSymmConTab[index].r_id - r_id;
    if( cr < 0 )
      from = index;
    else  {
      if( cr > 0 )
        to  = index;
      else  {
        if( cr == 0 )
          return &SortedSymmConTab[index];
      }
    }
  }
  return NULL;
}
//..............................................................................
